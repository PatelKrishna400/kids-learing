<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Shape Builder World - 1000 Levels of Fun!</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="voice-engine.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee3b2b",
                        "background-light": "#f8f6f6",
                        "background-dark": "#221210",
                    },
                    fontFamily: {
                        "display": ["Be Vietnam Pro", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .shape-shadow {
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
        }

        .silhouette-dash {
            stroke-dasharray: 8, 8;
        }

        .glow-active {
            box-shadow: 0 0 25px 10px rgba(254, 240, 138, 0.8);
        }

        .shape-draggable {
            touch-action: none;
            cursor: grab;
        }

        .shape-draggable:active {
            cursor: grabbing;
        }

        .drop-target-active {
            background-color: rgba(254, 240, 138, 0.3) !important;
            border-color: #fbbf24 !important;
        }

        .triangle-shape {
            width: 0;
            height: 0;
            border-left: 50% solid transparent;
            border-right: 50% solid transparent;
            border-bottom: 100% solid currentColor;
        }

        .diamond-shape {
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }

        .trapezoid-shape {
            clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%);
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display min-h-screen overflow-hidden select-none">
    <div class="layout-container flex h-screen flex-col">
        <!-- HEADER -->
        <header
            class="flex items-center justify-between bg-white/80 backdrop-blur-md border-b border-primary/10 px-6 py-4 sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <div class="bg-primary p-2 rounded-lg text-white">
                    <span class="material-symbols-outlined text-2xl" id="headerIcon">category</span>
                </div>
                <div>
                    <h2 class="text-slate-900 dark:text-slate-100 text-xl font-black tracking-tight">Shape Builder</h2>
                    <p class="text-[10px] font-bold text-primary uppercase tracking-widest mt-0.5" id="levelLabel">Level
                        1</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-4">
                    <div class="bg-slate-100 px-4 py-2 rounded-full flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary text-sm" id="levelNameIcon">home</span>
                        <span class="text-slate-900 text-xs font-bold uppercase tracking-wider"
                            id="levelNameText">House</span>
                    </div>
                    <button onclick="location.reload()"
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full text-sm font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                        Reset
                    </button>
                    <button onclick="window.location.href='index.html'"
                        class="bg-slate-800 text-white p-2 rounded-full hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined">home</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden relative">
            <!-- GAME PLAY AREA -->
            <div class="flex-1 relative overflow-hidden bg-sky-100" id="gameWorld">
                <!-- Decorations -->
                <div class="absolute inset-0 z-0 opacity-40">
                    <div class="absolute top-10 left-10 text-white"><span
                            class="material-symbols-outlined text-[120px]">cloud</span></div>
                    <div class="absolute top-24 right-32 text-white"><span
                            class="material-symbols-outlined text-[100px]">cloud</span></div>
                    <div
                        class="absolute bottom-0 w-full h-1/3 bg-emerald-400 rounded-t-[100%] scale-x-125 transform translate-y-10">
                    </div>
                </div>

                <div class="relative z-10 h-full flex flex-col items-center justify-center p-8">
                    <div
                        class="mb-8 text-center bg-white/30 backdrop-blur-sm px-8 py-4 rounded-3xl border border-white/50">
                        <h1 class="text-4xl md:text-5xl font-black text-slate-800 mb-2 drop-shadow-sm" id="levelTitle">
                            Build the House!</h1>
                        <p class="text-slate-600 font-bold" id="levelSubtitle">Drag the colorful shapes to the dotted
                            lines</p>
                    </div>

                    <!-- DROP ZONE -->
                    <div class="relative w-[500px] h-[500px]" id="dropZoneContainer">
                        <!-- Silhouette slots will be injected here -->
                    </div>
                </div>
            </div>

            <!-- SHAPE TRAY SIDEBAR -->
            <aside
                class="w-85 bg-white/90 backdrop-blur-xl border-l border-primary/10 p-6 flex flex-col gap-6 shadow-2xl z-20">
                <div class="flex items-center gap-3 border-b border-slate-100 pb-4">
                    <span class="material-symbols-outlined text-primary font-bold">inventory_2</span>
                    <h3 class="text-slate-900 font-black text-lg uppercase tracking-tight">Shape Tray</h3>
                </div>

                <div class="flex-1 overflow-y-auto pr-2 space-y-4 custom-scrollbar" id="shapeTray">
                    <!-- Draggable shapes will be injected here -->
                </div>

                <div class="pt-4 border-t border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Progress</span>
                        <span class="text-xs font-bold text-primary" id="progressText">0%</span>
                    </div>
                    <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-primary rounded-full transition-all duration-500" id="progressBar"
                            style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-center mt-3 text-slate-400 font-bold uppercase tracking-tight"
                        id="levelCounter">Level 1 of 1000</p>
                </div>
            </aside>
        </main>

        <!-- HINT BOX -->
        <div class="fixed bottom-10 left-10 z-30 max-w-xs animate-bounce" id="hintBox">
            <div class="bg-white p-5 rounded-2xl shadow-2xl border-t-4 border-primary relative">
                <div class="flex gap-3 items-start">
                    <div class="bg-amber-100 p-2 rounded-full text-amber-600 shrink-0">
                        <span class="material-symbols-outlined text-xl">lightbulb</span>
                    </div>
                    <p class="text-slate-800 font-bold text-sm leading-relaxed" id="hintText">
                        Welcome! Find the <span class="text-blue-500 underline">Blue Square</span> to start building!
                    </p>
                </div>
                <div class="absolute -bottom-2 left-8 w-4 h-4 bg-white rotate-45 border-r border-b border-slate-200">
                </div>
            </div>
        </div>

        <!-- WIN OVERLAY -->
        <div id="winOverlay"
            class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-md flex items-center justify-center hidden p-4">
            <div
                class="bg-white rounded-[3rem] p-12 text-center max-w-md w-full shadow-2xl border-8 border-primary relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-yellow-400 rounded-full opacity-20"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-primary rounded-full opacity-10"></div>

                <div class="text-8xl mb-6 floating" id="winIcon">üè†</div>
                <h2 class="text-4xl font-black text-slate-800 mb-2">AMAZING!</h2>
                <p class="text-slate-600 font-bold mb-8" id="winMessage">You've successfully built the House! Ready for
                    more?</p>

                <button onclick="nextLevel()"
                    class="bg-primary text-white text-2xl font-black px-12 py-5 rounded-full shadow-xl hover:scale-110 active:scale-95 transition-all w-full flex items-center justify-center gap-3">
                    NEXT LEVEL
                    <span class="material-symbols-outlined text-3xl">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const levelData = [
            {
                id: 1, name: "House", title: "Build the House!", icon: "home", emoji: "üè†",
                hint: "Find the <b>blue square</b> for the walls!",
                bg: "bg-sky-100",
                parts: [
                    { id: "walls", type: "square", w: 300, h: 250, x: 100, y: 150, color: "bg-blue-500", label: "Walls" },
                    { id: "roof", type: "triangle", w: 340, h: 180, x: 80, y: -30, color: "bg-red-500", label: "Roof" },
                    { id: "door", type: "trapezoid", w: 80, h: 120, x: 210, y: 280, color: "bg-emerald-500", label: "Door" }
                ]
            },
            {
                id: 3, name: "Rocket", title: "Build the Rocket!", icon: "rocket_launch", emoji: "üöÄ",
                hint: "The <b>blue body</b> is the strongest part!",
                bg: "bg-slate-900",
                parts: [
                    { id: "body", type: "square", w: 120, h: 220, x: 190, y: 150, color: "bg-blue-600", label: "Main Body", rounded: "rounded-t-full" },
                    { id: "tip", type: "triangle", w: 120, h: 80, x: 190, y: 70, color: "bg-red-500", label: "Rocket Tip" },
                    { id: "finL", type: "triangle", w: 60, h: 100, x: 130, y: 300, color: "bg-orange-500", label: "Left Fin", rotate: -30 },
                    { id: "finR", type: "triangle", w: 60, h: 100, x: 310, y: 300, color: "bg-orange-500", label: "Right Fin", rotate: 30 }
                ]
            },
            {
                id: 5, name: "Friendly Robot", title: "Assemble the Robot!", icon: "smart_toy", emoji: "ü§ñ",
                hint: "Start with the <b>grey body</b>!",
                bg: "bg-slate-50",
                parts: [
                    { id: "body", type: "square", w: 180, h: 220, x: 160, y: 180, color: "bg-slate-400", label: "Body" },
                    { id: "head", type: "square", w: 100, h: 90, x: 200, y: 80, color: "bg-emerald-400", label: "Head" },
                    { id: "armL", type: "square", w: 40, h: 150, x: 110, y: 180, color: "bg-yellow-400", label: "Left Arm" },
                    { id: "armR", type: "square", w: 40, h: 150, x: 350, y: 180, color: "bg-yellow-400", label: "Right Arm" }
                ]
            }
        ];

        let currentLevelIdx = 0;
        let placedParts = 0;
        let activeLevel = null;

        const dropZone = document.getElementById('dropZoneContainer');
        const shapeTray = document.getElementById('shapeTray');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const hintText = document.getElementById('hintText');
        const levelLabel = document.getElementById('levelLabel');
        const levelNameText = document.getElementById('levelNameText');
        const levelTitle = document.getElementById('levelTitle');
        const winOverlay = document.getElementById('winOverlay');

        function loadLevel(idx) {
            activeLevel = levelData[idx];
            placedParts = 0;

            // UI Setup
            levelLabel.innerText = `Level ${activeLevel.id}`;
            levelNameText.innerText = activeLevel.name;
            levelTitle.innerText = activeLevel.title;
            hintText.innerHTML = activeLevel.hint;
            document.getElementById('headerIcon').innerText = activeLevel.icon;
            document.getElementById('levelNameIcon').innerText = activeLevel.icon;
            document.getElementById('gameWorld').className = `flex-1 relative overflow-hidden transition-colors duration-1000 ${activeLevel.bg}`;
            document.getElementById('levelCounter').innerText = `Level ${activeLevel.id} of 1000`;

            dropZone.innerHTML = '';
            shapeTray.innerHTML = '';
            winOverlay.classList.add('hidden');
            updateProgress();

            // Sockets
            activeLevel.parts.forEach(p => {
                const socket = document.createElement('div');
                socket.id = `socket-${p.id}`;
                socket.className = `absolute border-4 border-dashed border-slate-400/30 bg-white/5 transition-all duration-300 ${p.rounded || ''}`;

                if (p.type === 'triangle') socket.classList.add('triangle-shape', 'border-0');
                if (p.type === 'diamond') socket.classList.add('diamond-shape');
                if (p.type === 'trapezoid') socket.classList.add('trapezoid-shape');

                socket.style.width = p.w + 'px';
                socket.style.height = p.h + 'px';
                socket.style.left = p.x + 'px';
                socket.style.top = p.y + 'px';
                if (p.rotate) socket.style.transform = `rotate(${p.rotate}deg)`;

                dropZone.appendChild(socket);

                // Draggable item in tray
                createTrayItem(p);
            });

            speak(`Level ${activeLevel.id}: ${activeLevel.title}`);
        }

        function createTrayItem(p) {
            const card = document.createElement('div');
            card.className = "group cursor-grab active:cursor-grabbing hover:scale-105 transition-transform bg-white p-4 rounded-xl shadow-sm border-2 border-slate-100 hover:border-primary flex flex-col items-center shape-draggable";

            const shape = document.createElement('div');
            shape.className = `shape-shadow mb-3 ${p.color} ${p.rounded || ''}`;
            shape.style.width = Math.min(p.w, 100) / 1.5 + 'px';
            shape.style.height = Math.min(p.h, 100) / 1.5 + 'px';

            if (p.type === 'triangle') shape.className += " triangle-shape";
            if (p.type === 'diamond') shape.className += " diamond-shape";
            if (p.type === 'trapezoid') shape.className += " trapezoid-shape";

            card.appendChild(shape);
            card.innerHTML += `<p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">${p.label}</p>`;

            card.onmousedown = (e) => startDragging(e, p, card);
            card.ontouchstart = (e) => startDragging(e.touches[0], p, card);

            shapeTray.appendChild(card);
        }

        function startDragging(e, part, sourceCard) {
            if (sourceCard.classList.contains('opacity-40')) return;

            const clone = sourceCard.cloneNode(true);
            clone.style.position = 'fixed';
            clone.style.width = part.w + 'px';
            clone.style.height = part.h + 'px';
            clone.style.zIndex = '1000';
            clone.classList.remove('hover:scale-105', 'bg-white', 'p-4', 'border-2');
            clone.classList.add('pointer-events-none');
            clone.querySelector('p').remove();

            // Adjust shape inside clone
            const shapeInClone = clone.querySelector('div');
            shapeInClone.style.width = '100%';
            shapeInClone.style.height = '100%';
            if (part.rotate) shapeInClone.style.transform = `rotate(${part.rotate}deg)`;

            document.body.appendChild(clone);

            const moveAt = (pageX, pageY) => {
                clone.style.left = pageX - part.w / 2 + 'px';
                clone.style.top = pageY - part.h / 2 + 'px';

                // Highlight target
                const socket = document.getElementById(`socket-${part.id}`);
                const sRect = socket.getBoundingClientRect();
                const dist = Math.hypot(pageX - (sRect.left + sRect.width / 2), pageY - (sRect.top + sRect.height / 2));

                if (dist < 100) socket.classList.add('drop-target-active');
                else socket.classList.remove('drop-target-active');
            };

            const onMouseMove = (e) => moveAt(e.clientX, e.clientY);
            const onTouchMove = (e) => moveAt(e.touches[0].clientX, e.touches[0].clientY);

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('touchmove', onTouchMove);

            const endDragging = (endX, endY) => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('touchmove', onTouchMove);

                const socket = document.getElementById(`socket-${part.id}`);
                const sRect = socket.getBoundingClientRect();
                const dist = Math.hypot(endX - (sRect.left + sRect.width / 2), endY - (sRect.top + sRect.height / 2));

                if (dist < 80) {
                    // SNAPPED
                    socket.classList.remove('drop-target-active', 'border-dashed', 'bg-white/5');
                    socket.className = `absolute ${part.color} ${part.rounded || ''} shadow-xl glow-active flex items-center justify-center z-10`;
                    if (part.type === 'triangle') socket.classList.add('triangle-shape');
                    if (part.type === 'diamond') socket.classList.add('diamond-shape');
                    if (part.type === 'trapezoid') socket.classList.add('trapezoid-shape');

                    socket.innerHTML = `<span class="material-symbols-outlined text-white/80 text-5xl font-bold animate-pulse">check</span>`;

                    sourceCard.classList.add('opacity-40', 'grayscale', 'cursor-default');
                    sourceCard.onmousedown = null;

                    placedParts++;
                    updateProgress();
                    speak("Great job!");

                    if (placedParts === activeLevel.parts.length) {
                        setTimeout(showWin, 500);
                    }
                }
                clone.remove();
            };

            document.onmouseup = (e) => {
                endDragging(e.clientX, e.clientY);
                document.onmouseup = null;
            };
            document.ontouchend = (e) => {
                endDragging(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                document.ontouchend = null;
            };
        }

        function updateProgress() {
            const perc = (placedParts / activeLevel.parts.length) * 100;
            document.getElementById('progressBar').style.width = perc + '%';
            document.getElementById('progressText').innerText = Math.floor(perc) + '%';
        }

        function showWin() {
            document.getElementById('winIcon').innerText = activeLevel.emoji;
            document.getElementById('winMessage').innerText = `You've successfully built the ${activeLevel.name}! Ready for more?`;
            winOverlay.classList.remove('hidden');
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            speak(`Awesome! You built the ${activeLevel.name}!`);
        }

        function nextLevel() {
            currentLevelIdx = (currentLevelIdx + 1) % levelData.length;
            loadLevel(currentLevelIdx);
        }

        loadLevel(0);
    </script>
</body>

</html>